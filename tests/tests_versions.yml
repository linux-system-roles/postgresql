# SPDX-License-Identifier: MIT
---
- name: Test installing and uninstalling all supported versions
  hosts: all
  tasks:
    - name: Skip test if distro does not support multiple versions
      meta: end_host
      when: ansible_facts['distribution'] not in ['CentOS', 'RedHat'] or
        ansible_facts['distribution_major_version'] not in ["8", "9"]

    - name: Install and cleanup default version
      include_tasks: tasks/install_and_check.yml
      vars:
        __test_check_version: true

    - name: Save default postgresql_version
      set_fact:
        __default_version: "{{ postgresql_version }}"

    - name: Install and cleanup the other supported versions
      include_tasks: tasks/install_and_check.yml
      loop: "{{ __versions }}"
      when: item != __default_version  # we already installed it
      vars:
        __test_check_version: true
        postgresql_version: "{{ item }}"
        __versions: "{{ __postgresql_versions_el8
          if ansible_facts['distribution_major_version'] == '8'
          else __postgresql_versions_el9
          if ansible_facts['distribution_major_version'] == '9'
          else [] }}"
